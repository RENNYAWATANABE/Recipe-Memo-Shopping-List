<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Recipe Memo & Shopping List</title>
    <link rel="icon" type="image/png" href="favicon.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg:#0b1220; --card:#0f1724; --muted:#94a3b8; --accent:#06b6d4; }
        body { font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: radial-gradient(circle at 10% 10%, rgba(255,255,255,0.02), transparent 1px), var(--bg); background-size: 28px 28px; color: #e6eef6; }
        .glass { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border: 1px solid rgba(255,255,255,0.04); backdrop-filter: blur(6px); }
        .accent { color: var(--accent); }
        .btn { transition: all .18s ease; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(6,182,212,0.08); }
        .scrollbar-thin::-webkit-scrollbar { height:8px; width:8px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 8px; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace; }
        /* responsive tweaks */
        @media (max-width: 1024px) {
          .max-w-6xl { padding-left: 12px; padding-right: 12px; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4">

<header class="w-full max-w-6xl mb-8 flex items-center justify-between">
    <div>
        <h1 class="text-3xl font-bold">Recipe Memo</h1>
        <p class="text-sm text-gray-400 mt-1">Save recipes, scale ingredients, and generate shopping lists</p>
    </div>
    <div class="flex items-center gap-3">
        <button id="importSample" class="btn bg-gray-800 text-sm py-2 px-3 rounded-md border border-gray-700">Import Sample</button>
        <button id="newRecipeBtn" class="btn bg-gradient-to-r from-sky-500 to-cyan-400 text-black text-sm py-2 px-4 rounded-md">New Recipe</button>
    </div>
</header>

<main class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Left: Recipe List + Filters -->
    <section class="lg:col-span-1">
        <div class="glass p-4 rounded-xl">
            <div class="flex items-center gap-3 mb-3">
                <input id="searchInput" type="text" placeholder="Search recipes or tags..." class="w-full bg-transparent border border-transparent focus:border-sky-500 rounded-md py-2 px-3 outline-none" />
                <select id="timeFilter" class="bg-transparent border border-gray-700 rounded-md py-2 px-2 text-sm">
                    <option value="">All time</option>
                    <option value="15">≤ 15 min</option>
                    <option value="30">≤ 30 min</option>
                    <option value="60">≤ 60 min</option>
                </select>
            </div>

            <div id="recipeList" class="space-y-3 max-h-[60vh] overflow-auto scrollbar-thin pr-2">
                <!-- recipe cards injected here -->
            </div>
        </div>

        <div class="glass mt-4 p-4 rounded-xl">
            <h3 class="font-semibold mb-2">Shopping List</h3>
            <div class="flex gap-2 mb-3">
                <button id="clearChecked" class="btn bg-gray-800 py-1 px-2 rounded-md text-sm">Clear checked</button>
                <button id="exportList" class="btn bg-gray-800 py-1 px-2 rounded-md text-sm">Copy list</button>
                <button id="resetList" class="btn bg-red-700 py-1 px-2 rounded-md text-sm">Reset</button>
            </div>
            <div id="shoppingList" class="max-h-[36vh] overflow-auto scrollbar-thin space-y-2">
                <!-- shopping items -->
            </div>
        </div>
    </section>

    <!-- Middle & Right: Recipe Detail / Editor -->
    <section class="lg:col-span-2">
        <div id="detailCard" class="glass p-6 rounded-xl min-h-[60vh]">
            <div id="emptyState" class="text-center py-20">
                <p class="text-gray-400">No recipe selected. Create a new recipe or import sample recipes.</p>
            </div>

            <div id="recipeDetail" class="hidden">
                <div class="flex items-start justify-between">
                    <div>
                        <h2 id="detailTitle" class="text-2xl font-bold"></h2>
                        <div class="text-sm text-gray-400 mt-1 flex gap-3 items-center">
                            <span id="detailTime"></span>
                            <span id="detailTags" class="px-2 py-0.5 rounded-md bg-white/3 text-xs"></span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-400 mr-2">Servings</label>
                        <input id="servingsInput" type="number" min="1" value="1" class="w-20 bg-transparent border border-gray-700 rounded-md py-1 px-2 text-center" />
                        <button id="addToShopping" class="btn ml-3 bg-gradient-to-r from-sky-500 to-cyan-400 text-black py-2 px-3 rounded-md">Add to Shopping List</button>
                        <button id="editRecipeBtn" class="btn bg-gray-800 py-2 px-3 rounded-md">Edit</button>
                        <button id="deleteRecipeBtn" class="btn bg-red-700 py-2 px-3 rounded-md">Delete</button>
                    </div>
                </div>

                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-semibold mb-2">Ingredients</h3>
                        <ul id="ingredientsList" class="space-y-2 text-gray-200"></ul>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2">Steps</h3>
                        <ol id="stepsList" class="list-decimal ml-5 space-y-2 text-gray-200"></ol>
                    </div>
                </div>

                <div class="mt-6">
                    <h3 class="font-semibold mb-2">Notes / Photo</h3>
                    <div id="notesArea" class="text-gray-300"></div>
                    <div id="photoArea" class="mt-3"></div>
                </div>
            </div>

            <!-- Editor Inline -->
            <div id="editor" class="hidden mt-4">
                <h3 class="font-semibold mb-3">Recipe Editor</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-400">Title</label>
                        <input id="rTitle" class="w-full bg-transparent border border-gray-700 rounded-md py-2 px-3" />
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">Tags (comma separated)</label>
                        <input id="rTags" class="w-full bg-transparent border border-gray-700 rounded-md py-2 px-3" />
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">Time (minutes)</label>
                        <input id="rTime" type="number" min="1" class="w-full bg-transparent border border-gray-700 rounded-md py-2 px-3" />
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">Servings (default)</label>
                        <input id="rServings" type="number" min="1" class="w-full bg-transparent border border-gray-700 rounded-md py-2 px-3" />
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm text-gray-400">Ingredients (one per line: amount unit name)</label>
                        <textarea id="rIngredients" rows="6" class="w-full bg-transparent border border-gray-700 rounded-md py-2 px-3 mono"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm text-gray-400">Steps (one per line)</label>
                        <textarea id="rSteps" rows="6" class="w-full bg-transparent border border-gray-700 rounded-md py-2 px-3"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm text-gray-400">Notes / Photo URL</label>
                        <input id="rNotes" class="w-full bg-transparent border border-gray-700 rounded-md py-2 px-3" placeholder="Optional photo URL" />
                    </div>
                </div>

                <div class="mt-4 flex gap-2">
                    <button id="saveRecipeBtn" class="btn bg-gradient-to-r from-sky-500 to-cyan-400 text-black py-2 px-4 rounded-md">Save</button>
                    <button id="cancelEditBtn" class="btn bg-gray-800 py-2 px-4 rounded-md">Cancel</button>
                </div>
            </div>

        </div>
    </section>

</main>

<footer class="mt-12 text-gray-600 text-sm">
    &copy; 2025 Rennya Watanabe Portfolio
</footer>

<script>
    /* -------------------------
       Data model & persistence
       ------------------------- */
    const STORAGE_KEY = 'recipe_memo_v1';
    let state = {
      recipes: [],
      selectedId: null,
      shopping: {} // {ingredientKey: {name, qty, unit, checked, source}}
    };

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try { state = JSON.parse(raw); } catch(e){ console.error(e); state = { recipes: [], selectedId: null, shopping: {} }; }
      } else {
        state = { recipes: [], selectedId: null, shopping: {} };
      }
    }

    /* -------------------------
       Utilities: parse ingredient
       ------------------------- */
    function parseIngredientLine(line) {
      line = (line || '').trim();
      if (!line) return null;
      const parts = line.split(/\s+/);
      let amount = parts[0];
      let unit = '';
      let name = '';
      if (!isNaN(parseFloat(amount))) {
        if (parts.length >= 3) {
          unit = parts[1];
          name = parts.slice(2).join(' ');
        } else {
          name = parts.slice(1).join(' ') || '';
        }
      } else {
        amount = '';
        name = parts.join(' ');
      }
      return { raw: line, amount: amount || '', unit: unit || '', name: name || '' };
    }

    function normalizeName(name) {
      return (name || '').trim().toLowerCase().replace(/　/g,' ').replace(/\s+/g,' ');
    }

    /* -------------------------
       Rendering functions
       ------------------------- */
    const recipeListEl = document.getElementById('recipeList');
    const shoppingListEl = document.getElementById('shoppingList');
    const detailTitle = document.getElementById('detailTitle');
    const detailTime = document.getElementById('detailTime');
    const detailTags = document.getElementById('detailTags');
    const ingredientsList = document.getElementById('ingredientsList');
    const stepsList = document.getElementById('stepsList');
    const notesArea = document.getElementById('notesArea');
    const photoArea = document.getElementById('photoArea');
    const recipeDetail = document.getElementById('recipeDetail');
    const emptyState = document.getElementById('emptyState');
    const editor = document.getElementById('editor');
    const servingsInput = document.getElementById('servingsInput');

    function renderRecipeList() {
      recipeListEl.innerHTML = '';
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      const timeFilter = document.getElementById('timeFilter').value;
      const filtered = state.recipes.filter(r => {
        if (q) {
          const inText = (r.title + ' ' + (r.tags||'') + ' ' + (r.ingredients||'') + ' ' + (r.steps||'')).toLowerCase();
          if (!inText.includes(q)) return false;
        }
        if (timeFilter) {
          if (!r.time || Number(r.time) > Number(timeFilter)) return false;
        }
        return true;
      });
      if (filtered.length === 0) {
        recipeListEl.innerHTML = '<p class="text-gray-500 text-sm">No recipes found.</p>';
        return;
      }
      filtered.forEach(r => {
        const card = document.createElement('div');
        card.className = 'p-3 rounded-lg glass flex items-center gap-3 cursor-pointer hover:border-sky-500 border border-transparent';
        card.innerHTML = `
          <div class="w-12 h-12 rounded-full bg-white/3 flex items-center justify-center text-xl font-semibold">${(r.title||'R').slice(0,1).toUpperCase()}</div>
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <div class="font-semibold">${r.title}</div>
              <div class="text-xs text-gray-400">${r.time ? r.time + 'm' : ''}</div>
            </div>
            <div class="text-xs text-gray-400 mt-1">${(r.tags||'').split(',').slice(0,3).map(t=>t.trim()).filter(Boolean).join(' • ')}</div>
          </div>
        `;
        card.addEventListener('click', () => {
          selectRecipe(r.id);
        });
        recipeListEl.appendChild(card);
      });
    }

    function renderDetail() {
      const id = state.selectedId;
      if (!id) {
        recipeDetail.classList.add('hidden');
        editor.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }
      const r = state.recipes.find(x => x.id === id);
      if (!r) return;
      emptyState.classList.add('hidden');
      recipeDetail.classList.remove('hidden');
      editor.classList.add('hidden');

      detailTitle.textContent = r.title;
      detailTime.textContent = r.time ? `${r.time} min` : '';
      detailTags.textContent = (r.tags||'').split(',').map(t=>t.trim()).filter(Boolean).join(', ');
      servingsInput.value = r.servings || 1;

      // ingredients
      ingredientsList.innerHTML = '';
      const baseServings = r.servings || 1;
      const targetServings = Number(servingsInput.value) || baseServings;
      const scale = targetServings / baseServings;
      r.ingredients.split('\n').map(l => l.trim()).filter(Boolean).forEach(line => {
        const parsed = parseIngredientLine(line) || {raw:line, amount:'', unit:'', name:line};
        let displayAmount = parsed.amount;
        if (displayAmount && !isNaN(parseFloat(displayAmount))) {
          displayAmount = (parseFloat(displayAmount) * scale).toString().replace(/\.0+$/,'');
        }
        const li = document.createElement('li');
        li.className = 'flex items-start justify-between';
        li.innerHTML = `<div><span class="font-medium">${displayAmount ? displayAmount + ' ' : ''}${parsed.unit ? parsed.unit + ' ' : ''}</span><span>${parsed.name}</span></div>`;
        ingredientsList.appendChild(li);
      });

      // steps
      stepsList.innerHTML = '';
      r.steps.split('\n').map(s=>s.trim()).filter(Boolean).forEach(step => {
        const li = document.createElement('li');
        li.textContent = step;
        stepsList.appendChild(li);
      });

      notesArea.textContent = r.notes || '';
      photoArea.innerHTML = '';
      if (r.photo) {
        const img = document.createElement('img');
        img.src = r.photo;
        img.alt = r.title;
        img.className = 'mt-2 rounded-md max-h-48 object-cover';
        photoArea.appendChild(img);
      }
    }

    function renderShopping() {
      shoppingListEl.innerHTML = '';
      const keys = Object.keys(state.shopping);
      if (keys.length === 0) {
        shoppingListEl.innerHTML = '<p class="text-gray-500 text-sm">Shopping list is empty.</p>';
        return;
      }
      keys.forEach(k => {
        const it = state.shopping[k];
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between p-2 rounded-md bg-white/2';
        row.innerHTML = `
          <label class="flex items-center gap-3">
            <input type="checkbox" ${it.checked ? 'checked' : ''} class="w-4 h-4" />
            <div>
              <div class="font-medium">${it.qty ? it.qty + ' ' : ''}${it.unit ? it.unit + ' ' : ''}${it.name}</div>
              <div class="text-xs text-gray-400">${it.source || ''}</div>
            </div>
          </label>
          <div class="flex items-center gap-2">
            <button class="text-xs text-gray-300 btn remove">×</button>
          </div>
        `;
        const checkbox = row.querySelector('input[type=checkbox]');
        checkbox.addEventListener('change', () => {
          it.checked = checkbox.checked;
          saveState(); renderShopping();
        });
        row.querySelector('.remove').addEventListener('click', () => {
          delete state.shopping[k];
          saveState(); renderShopping();
        });
        shoppingListEl.appendChild(row);
      });
    }

    /* -------------------------
       Actions
       ------------------------- */
    function selectRecipe(id) {
      state.selectedId = id;
      saveState();
      renderRecipeList();
      renderDetail();
    }

    function openEditor(recipe) {
      document.getElementById('rTitle').value = recipe?.title || '';
      document.getElementById('rTags').value = recipe?.tags || '';
      document.getElementById('rTime').value = recipe?.time || '';
      document.getElementById('rServings').value = recipe?.servings || 1;
      document.getElementById('rIngredients').value = recipe?.ingredients || '';
      document.getElementById('rSteps').value = recipe?.steps || '';
      document.getElementById('rNotes').value = recipe?.notes || '';
      editor.classList.remove('hidden');
      recipeDetail.classList.add('hidden');
      emptyState.classList.add('hidden');
      editor.dataset.editId = recipe?.id || '';
    }

    function closeEditor() {
      editor.classList.add('hidden');
      if (state.selectedId) {
        recipeDetail.classList.remove('hidden');
      } else {
        emptyState.classList.remove('hidden');
      }
    }

    function saveRecipeFromEditor() {
      const id = editor.dataset.editId || null;
      const title = document.getElementById('rTitle').value.trim();
      if (!title) { alert('Title is required'); return; }
      const tags = document.getElementById('rTags').value.trim();
      const time = document.getElementById('rTime').value.trim();
      const servings = Number(document.getElementById('rServings').value) || 1;
      const ingredients = document.getElementById('rIngredients').value.trim();
      const steps = document.getElementById('rSteps').value.trim();
      const notes = document.getElementById('rNotes').value.trim();
      const photo = notes && (notes.startsWith('http') || notes.startsWith('data:')) ? notes : '';

      if (id) {
        const idx = state.recipes.findIndex(r => r.id === id);
        if (idx >= 0) {
          state.recipes[idx] = { ...state.recipes[idx], title, tags, time, servings, ingredients, steps, notes, photo };
          state.selectedId = id;
        }
      } else {
        const newId = 'r_' + Date.now();
        state.recipes.unshift({ id: newId, title, tags, time, servings, ingredients, steps, notes, photo });
        state.selectedId = newId;
      }
      saveState();
      renderRecipeList();
      renderDetail();
      closeEditor();
    }

    function deleteSelectedRecipe() {
      if (!state.selectedId) return;
      if (!confirm('Delete this recipe?')) return;
      state.recipes = state.recipes.filter(r => r.id !== state.selectedId);
      state.selectedId = state.recipes.length ? state.recipes[0].id : null;
      saveState();
      renderRecipeList();
      renderDetail();
    }

    function addRecipeToShopping() {
      const r = state.recipes.find(x => x.id === state.selectedId);
      if (!r) return;
      const baseServings = r.servings || 1;
      const targetServings = Number(servingsInput.value) || baseServings;
      const scale = targetServings / baseServings;
      r.ingredients.split('\n').map(l=>l.trim()).filter(Boolean).forEach(line => {
        const p = parseIngredientLine(line) || {amount:'',unit:'',name:line};
        const qty = p.amount && !isNaN(parseFloat(p.amount)) ? (parseFloat(p.amount) * scale) : p.amount;
        const nameNorm = normalizeName(p.name || '');
        const key = nameNorm + '|' + (p.unit||'');
        if (state.shopping[key]) {
          const existing = state.shopping[key];
          if (!isNaN(parseFloat(existing.qty)) && !isNaN(parseFloat(qty))) {
            existing.qty = (parseFloat(existing.qty) + parseFloat(qty)).toString();
          } else {
            existing.qty = existing.qty ? existing.qty + ' + ' + (qty || p.raw) : (qty || p.raw);
          }
          existing.source = (existing.source || '') + ', ' + r.title;
        } else {
          state.shopping[key] = { name: p.name, qty: qty ? qty.toString() : '', unit: p.unit, checked: false, source: r.title };
        }
      });
      saveState();
      renderShopping();
      alert('Added to shopping list');
    }

    /* -------------------------
       Event bindings
       ------------------------- */
    document.getElementById('newRecipeBtn').addEventListener('click', () => openEditor(null));
    document.getElementById('saveRecipeBtn').addEventListener('click', saveRecipeFromEditor);
    document.getElementById('cancelEditBtn').addEventListener('click', closeEditor);
    document.getElementById('editRecipeBtn').addEventListener('click', () => {
      const r = state.recipes.find(x => x.id === state.selectedId);
      openEditor(r);
    });
    document.getElementById('deleteRecipeBtn').addEventListener('click', deleteSelectedRecipe);
    document.getElementById('addToShopping').addEventListener('click', addRecipeToShopping);
    document.getElementById('searchInput').addEventListener('input', renderRecipeList);
    document.getElementById('timeFilter').addEventListener('change', renderRecipeList);
    document.getElementById('servingsInput').addEventListener('change', renderDetail);

    document.getElementById('clearChecked').addEventListener('click', () => {
      Object.keys(state.shopping).forEach(k => { if (state.shopping[k].checked) delete state.shopping[k]; });
      saveState(); renderShopping();
    });
    document.getElementById('resetList').addEventListener('click', () => {
      if (!confirm('Clear entire shopping list?')) return;
      state.shopping = {}; saveState(); renderShopping();
    });
    document.getElementById('exportList').addEventListener('click', () => {
      const lines = Object.values(state.shopping).map(it => `${it.qty ? it.qty + ' ' : ''}${it.unit ? it.unit + ' ' : ''}${it.name}`);
      navigator.clipboard?.writeText(lines.join('\n')).then(()=> alert('Copied to clipboard'), ()=> alert('Copy failed'));
    });

    document.getElementById('importSample').addEventListener('click', () => {
      importSampleRecipes();
    });

    /* -------------------------
       Sample data
       ------------------------- */
    function importSampleRecipes() {
      const sample = [
        {
          id: 'r_sample_1',
          title: '鶏の照り焼き',
          tags: 'dinner,meat',
          time: '25',
          servings: 2,
          ingredients: '300 g 鶏もも肉\n2 tbsp 醤油\n1 tbsp みりん\n1 tbsp 砂糖\n1 tsp 生姜(すりおろし)',
          steps: '鶏肉に切り込みを入れる\nフライパンで皮目から焼く\n調味料を混ぜて加える\n煮詰めて照りを出す',
          notes: '',
          photo: ''
        },
        {
          id: 'r_sample_2',
          title: '簡単野菜スープ',
          tags: 'soup,vegetarian',
          time: '20',
          servings: 2,
          ingredients: '1 個 玉ねぎ\n2 本 にんじん\n1 個 じゃがいも\n500 ml 水\n1 tsp コンソメ',
          steps: '野菜を切る\n鍋で炒める\n水とコンソメを入れて煮る\n塩で味を整える',
          notes: '',
          photo: ''
        }
      ];
      sample.forEach(s => {
        if (!state.recipes.find(r => r.title === s.title)) state.recipes.push(s);
      });
      saveState(); renderRecipeList(); alert('Sample recipes imported');
    }

    /* -------------------------
       Init
       ------------------------- */
    loadState();
    if (!state.recipes || state.recipes.length === 0) importSampleRecipes();
    if (!state.selectedId && state.recipes.length) state.selectedId = state.recipes[0].id;
    renderRecipeList();
    renderDetail();
    renderShopping();

    // expose for debugging (optional)
    window._app = { state, saveState, loadState };
</script>

</body>
</html>
